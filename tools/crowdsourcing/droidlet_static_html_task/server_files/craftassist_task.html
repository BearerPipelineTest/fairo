<!-- craftassist_task.html -->	
<!-- Bootstrap v3.0.3 -->	
<link	
  rel="stylesheet"	
  href="https://stackpath.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"	
/>	
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>	
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>	
<!-- Modal --><!-- MODAL -->	
<div	
  aria-hidden="true"	
  aria-labelledby="exampleModalLabel"	
  class="modal fade bd-example-modal-lg"	
  id="exampleModal"	
  role="dialog"	
  tabindex="-1"	
>	
  <div class="modal-dialog modal-lg" role="document">	
    <div class="modal-content">	
      <div class="modal-header">	
          <span aria-hidden="true"> &times; </span>	
        </button>	
        <nav aria-label="Instruction page navigation">	
          <ul class="pagination justify-content-center">	
            <li class="page-item disabled" id="previous">	
              <a class="page-link" tabindex="-1" href="#" onclick="incrementPage(-1);return false;" role="button" aria-expanded="false" aria-controls="collapseExample">Previous</a>	
            </li>	
            <li class="page-item active" id="pg1">	
              <a class="page-link" tabindex="-1" href="#" onclick="applyPagination(1);return false;" role="button" aria-expanded="true" aria-controls="collapseExample">1</a>	
            </li>	
            <li class="page-item" id="pg2">	
              <a class="page-link" tabindex="-1" href="#" onclick="applyPagination(2);return false;" role="button" aria-expanded="false" aria-controls="collapseExample">2</a>	
            </li>	
            <li class="page-item" id="pg3">	
              <a class="page-link" tabindex="-1" href="#" onclick="applyPagination(3);return false;" role="button" aria-expanded="false" aria-controls="collapseExample">3</a>	
            </li>	
            <li class="page-item" id="pg4">	
              <a class="page-link" tabindex="-1" href="#" onclick="applyPagination(4);return false;" role="button" aria-expanded="false" aria-controls="collapseExample">4</a>	
            </li>	
            <li class="page-item" id="pg5">	
              <a class="page-link" tabindex="-1" href="#" onclick="applyPagination(5);return false;" role="button" aria-expanded="false" aria-controls="collapseExample">5</a>	
            </li>	
            <!--
            <li class="page-item" id="pg6">	
              <a class="page-link" tabindex="-1" href="#" onclick="applyPagination(6);return false;" role="button" aria-expanded="false" aria-controls="collapseExample">6</a>	
            </li>
            -->	
            <li class="page-item" id="next">	
              <a class="page-link" tabindex="-1" href="#" onclick="incrementPage(1);return false;" role="button" aria-expanded="false" aria-controls="collapseExample">Next</a>	
            </li>	
          </ul>	
        </nav>	
      </div>	
      <div class="modal-body" id="modal"></div>	
      <div class="modal-footer">	
        <button class="btn btn-primary" id="close-instructions-btn" onclick="recordReadTime()" data-dismiss="modal" type="button" style="display:none">Close</button>	
      </div>	
    </div>	
  </div>	
</div>

	<!-- Content -->	
  <section	
  class="container"	
  id="Other"	
  style="	
    padding: 10px;	
    font-family: Verdana, Geneva, sans-serif;	
    font-size: 0.9em;	
  "	
>	
  <div class="row col-xs-12 col-md-12">	
    <!-- Instructions -->	
    <div class="panel panel-primary">	
      <div class="panel-heading">	
        <button class="btn btn-primary" type="button" onclick="showHideInstructions()" aria-expanded="false" aria-controls="instructionsWrapper">	
          Click here to view/hide instructions	
        </button>	
      </div>	
      <div class="collapse" id=instructionsWrapper>	
        <div id="instructions">	
          <div class="collapse in" id="instructions-page-1">	
            <h1><strong>Interact with an assistant in a 3-D world</strong></h1>    	
            <img src="https://craftassist.s3-us-west-2.amazonaws.com/pubr/voxel_world_agent_labeled.png" class="previews"></iframe>	
            <img src="https://craftassist.s3-us-west-2.amazonaws.com/pubr/voxel_2_labeled.png" class="previews"></iframe>	
            <img src="https://craftassist.s3-us-west-2.amazonaws.com/pubr/voxel_3_labeled.png" class="previews"></iframe>	
            <p>	
              <h3>You are playing a game in a 3-D world with an assistant who can help you.</h3>	
              <h4>Use your imagination and creativity to <i>interact with the assistant by asking it to do things.</i></h4>	
            </p>	
          	
            <p><b style="color: red;">	
              IMPORTANT - Please note that you will only get paid if you:	
              <ol>	
                <li>Click "Start" in the bottom right to begin session.</li>	
                <li>Interact with the assistant for the <i>full 5 minutes.</i></li>	
                <li>Click on "End" in the bottom right.</li>	
                <li>Rate the clarity and usability of the HIT.</li>	
                <li>Click on "Submit" button at the bottom.</li>	
              </ol>	
              Please read these instructions carefully!  You should spend 3 minutes reading and understanding.	
            </b></p>	
          </div>	
          <div class="collapse" id="instructions-page-2">	
            <h3>Example Task Interface</h3>	
            <img class=center src="https://craftassist.s3-us-west-2.amazonaws.com/pubr/mturk_dashboard.png" width="60%"></iframe>	
            <h3>How to move around the 3-D world</h3>	
            <p>	
              <ul>	
                <li>Click on the upper right pane to enter the game.</li>	
                <li>Press ‘w/a/s/d’ buttons to move forward/left/back/right and ‘space’ to jump.</li>	
                <li>Press ‘esc’ to leave the world.</li>	
              </ul>	
            </p>	
          </div>	
          	
          <div class="collapse" id="instructions-page-3">	
            <h3>Interacting with the assistant</h3>	
            <p>	
              Please use the <b>chat box in the top left pane</b> to chat with the assistant. <br>	
              We ask that you interact with the assistant for <b>at least 5 minutes.</b>	
              <img class=center src="https://craftassist.s3-us-west-2.amazonaws.com/pubr/dashboard_text_entry_highlight.png" width="60%"></iframe>	
            </p>	
            <p>	
              <ul>	
                <li><b>Press “submit” just below the chat box to send the command to the assistant.</b></li>	
                <li><b>The assistant might be slow to respond. Please be patient and do not send multiple commands at a time.</b></li>	
                <li>You should then see the assistant execute the command in the 3-D world.</li>	
                <li>The assistant might also send you replies below the chat box.</li>	
                <li>In the bottom left pane are the last 5 commands you’ve sent.</li>	
              </ul>	
            </p>	
          </div>	
          <div class="collapse" id="instructions-page-4">	
            <h3>Assistant Capabilities</h3>	
            <h4 style="color: red;">Keep in mind that the assistant is non-violent!</h4>	
            <ul>	
              <li><b>Move</b> (to a place or structure)</li>	
              <li><b>Build</b> (a shape or structure)</li>	
              <li><b>Destroy</b> (a structure)</li>	
              <li><b>Dance</b></li>	
              <li><b>Get</b> (an object)</li>	
              <li><b>Tag</b> (rename something)</li>	
              <li><b>Dig</b></li>	
              <li><b>Copy</b> (make a copy of an object)</li>	
              <li><b>Undo</b></li>	
              <li><b>Fill</b> (up a hole or structure)</li>	
              <li><b>Spawn</b> (create an animal)</li>	
              <li><b>Answer</b> (a question)</li>	
              <li><b>Stop</b></li>	
              <li><b>Resume</b> (an earlier action)</li>	
            </ul>	
            <p>	
              <b>Example Command 1: </b>"Build a red square there"<br>	
              <b>Example Command 2: </b>"Dig a hole next to this red square"	
            </p>	
          </div>	
          <!--	
          <div class="collapse" id="instructions-page-5">	
            <h3> Mark Errors <b style="color: red;">- Very Important!</b></h3>	
            <p>	
              If the assistant fails to do something you asked, you must click the <b style="color:red;">MARK ERROR</b> button.	
            </p>	
            <img class=center src="https://craftassist.s3-us-west-2.amazonaws.com/pubr/mark_errors_big_button.png" width="80%"></iframe><br>	
            <p>	
              <b>Example Error 1: </b>"Move..." -> Assistant doesn't move or moves to the wrong location.<br>	
              <b>Example Error 2: </b>"Get..." -> Assistant retrieves the wrong thing or nothing.	
            </p>	
          </div>	
          -->	
          <div class="collapse" id="instructions-page-5">	
            <h3>Tips</h3>	
            <ul>	
              <li><b>Be creative! Make the interaction interesting, within the assistant's capabilities.</b></li>	
              <li><b>Please use as much variety as you can! Don't give the same commands over and over</b></li>	
              <li><b>Include only one sentence in each command.</b></li>	
            </ul>	
            <p>	
              <h3 style="color:red;">Rejection policy - You HIT will be rejected if any of these are violated:</h3>	
            </p>	
            	
            <ul>	
              <li>The commands must be valid English sentences.</li>	
              <li>The commands must use the above list of capabilities</li>	
              <li>All commands must be unique.</li>	
              <li>If you do multiple HITs, you must use new commands each time.</li>	
            </ul>	
          </div>	
        </div>	
      </div>	
    </div>	
    <!-- End Instructions -->
  </div>
</section>

<section	
  class="container-fluid"	
  id="Other"	
  style="	
    margin-bottom: 15px;	
    padding: 10px;	
    font-family: Verdana, Geneva, sans-serif;	
    font-size: 0.9em;"	
>
  <div class="row">
    <!-- Commands Reminder -->
    <div class="col-xs-2">
      <div class="panel panel-primary" style="height:1000px;">
        <div class="panel-heading">
          <strong>Assistant Capabilities</strong>
        </div>
        <p>
          <ul>
            <li><b>Move</b> (to a place or structure)</li>
            <li><b>Build</b> (a shape or structure)</li>
            <li><b>Destroy</b> (a structure)</li>
            <li><b>Dance</b></li>
            <li><b>Get</b> (an object)</li>
            <li><b>Tag</b> (rename something)</li>
            <li><b>Dig</b></li>
            <li><b>Copy</b> (make a copy of an object)</li>
            <li><b>Undo</b></li>
            <li><b>Fill</b> (up a hole or structure)</li>
            <li><b>Spawn</b> (create an animal)</li>
            <li><b>Answer</b> (a question)</li>
            <li><b>Stop</b> </li>
            <li><b>Resume</b> (an earlier action)</li>
          </ul>
        </p>
      </div>
    </div>
    <!-- End Commands Reminder -->
    <div class="col-xs-10">
      <iframe style="width:100%; height:1000px;" src="https://${subdomain}.craftassist.io/turk.html?turk_experiment_id=${batch}&mephisto_agent_id=${mephisto_agent_id}&turk_worker_id=${provider_worker_id}"></iframe>
    </div>
  </div>
</section>

<section class="container" style="margin-bottom: 20px">
  <fieldset>
    <div class="input-group center">
      <h4>Please rate the clarity and usability of this HIT</h4>
      <select class="form-control" name="usability-rating" onchange="usabilityRated()">
        <option selected="selected" value="">(select one)</option>
        <option value="7">7 - Perfect</option>
        <option value="6">6 - Very Good</option>
        <option value="5">5 - Decent</option>
        <option value="4">4 - OK</option>
        <option value="3">3 - Poor</option>
        <option value="2">2 - Very Poor</option>
        <option value="1">1 - Unusable</option>
      </select><br>
      <h4>Please rate your own performance and the quality of your contribution</h4>
      <select class="form-control" name="self-rating" onchange="selfRated()">
        <option selected="selected" value="">(select one)</option>
        <option value="5">5 - Outstanding</option>
        <option value="4">4 - Good</option>
        <option value="3">3 - Acceptable</option>
        <option value="2">2 - Poor</option>
        <option value="1">1 - Very Poor</option>
      </select>
      <input type="hidden" id="clickedElements" name="clickedElements" value="0">
      <input type="hidden" id="instructionsReadTime" name="instructionsReadTime" value="0">
      <input type="hidden" id="preInteractTime" name="preInteractTime" value="0">
      <input type="hidden" id="interactTime" name="interactTime" value="0">
      <input type="hidden" id="userAgent" name="userAgent" value="0">
    </div>
  </fieldset>
</section>


<script>
  var timerStopped = false;
  var ratingComplete = false;
  var selfRatingComplete = false;

  var clickedElements = new Array();
  function recordClick(ele) {
    clickedElements.push({id: ele, timestamp: Date.now()});
    document.getElementById("clickedElements").value = clickedElements;
    console.log("Clicked elements array: " + JSON.stringify(clickedElements));
  }

  function checkSubmitDisplay() {
    //Only display the submit button if the worker has interacted with the dashboard and completed the survey
    if (ratingComplete && selfRatingComplete && timerStopped) {
      document.getElementsByClassName("btn-default")[0].classList.remove("hidden");
      window.scrollTo(0,document.body.scrollHeight);
    }
  }

  function usabilityRated() {
    ratingComplete = true;
    recordClick("usability-rated");
    checkSubmitDisplay();
  }

  function selfRated() {
    selfRatingComplete = true;
    recordClick("self-rated");
    checkSubmitDisplay();
  }

  const start = Date.now();
  var readTimestamp = start;
  var startButtonTimestamp = start;
  var stopButtonTimestamp = start;

  function recordReadTime() {
    recordClick("instructions-popup-close");
    readTimestamp = Date.now();
    readTime = Math.floor((readTimestamp - start)/1000);
    document.getElementById("instructionsReadTime").value = readTime;

    //Also take this opportunity to do some other housekeeping that doesn't work well with MTurk...
    document.getElementsByClassName("btn-default")[0].classList.add("hidden");
    if (window.addEventListener) {
      window.addEventListener("message", (event) => {
        data = JSON.parse(event.data);
        console.log(data);
        if (data.msg === "timerON") recordStartButtonTime();
        else if (data.msg === "timerOFF") recordInteractTime();
        else recordClick(data.msg);
        // In the future can also use this to record interaction quality scores
        checkSubmitDisplay();
      }, false);
    }
    else if (window.attachEvent) {  // Cross compatibility for old versions of IE8
      window.attachEvent("onmessage", (event) => {
        data = JSON.parse(event.data);
        console.log(data);
        if (data.msg === "timerON") recordStartButtonTime();
        else if (data.msg === "timerOFF") recordInteractTime();
        else recordClick(data.msg);
        checkSubmitDisplay();
      });
    }
  }

  // Can probably deprecate these functions in favor of doing everything through recordClick
  function recordStartButtonTime() {
    startButtonTimestamp = Date.now();
    preInteractTime = Math.floor((startButtonTimestamp - readTimestamp)/1000);
    document.getElementById("preInteractTime").value = preInteractTime;
    recordClick("start-btn");
  }
  function recordInteractTime() {
    timerStopped = true;
    stopButtonTimestamp = Date.now();
    interactTime = Math.floor((stopButtonTimestamp - startButtonTimestamp)/1000);
    document.getElementById("interactTime").value = interactTime;
    recordClick("end-btn");
  }

  function showHideInstructions() {
    if (document.getElementById("instructionsWrapper").classList.contains("in")){
      for (let ele of document.getElementsByClassName("collapse")){
        if (ele.classList.contains("in")) ele.classList.remove("in");
      }
    }
    else {
      for (let ele of document.getElementsByClassName("collapse")){
        if (ele.classList.contains("in")) continue;
        else ele.classList.add("in");
      }
    }
    recordClick("toggle-instructions");
  }
  
  $(function () {
    modal_body = $("#modal");
    $("#instructions").clone().appendTo(modal_body);
    $(".modal").modal("show");
  });

  var page = 1;
  const numPages = 5;
  
  function incrementPage(val) {
    page += val;
    if (page < 1) page = 1;
    if (page > numPages) page = numPages;
    applyPagination(page);
  }

  function applyPagination(pg) {
    const pageID = "page-" + pg;
    recordClick(pageID);
    page = pg;

    if (pg === 1) document.getElementById("previous").classList.add("disabled");
    else document.getElementById("previous").classList.remove("disabled");
    if (pg === numPages) {
      document.getElementById("next").classList.add("disabled");
      document.getElementById("close-instructions-btn").style.display = "block";
    }
    else document.getElementById("next").classList.remove("disabled");
    let pgID, btnID;
    for (let i=1; i<=numPages; i++) {
      pgID = "instructions-page-" + i;
      btnID = "pg" + i;
      if (i === pg) {
        document.getElementById(btnID).classList.add("active");
        document.getElementById(pgID).classList.add("in");
      }
      else {
        document.getElementById(btnID).classList.remove("active");
        document.getElementById(pgID).classList.remove("in");
      }
    }
  }

  /*  Figure out user broswer and OS and record */
  // From If-dev on codegrepper.com
  
  agent = {browser:{name:null,version:null,v:null,userAgent:null,app:null,os:null},mobile:false,pointlock:false};

  var nVer = navigator.appVersion;
  var nAgt = navigator.userAgent;
  var browserName  = navigator.appName;
  var fullVersion  = ''+parseFloat(navigator.appVersion); 
  var majorVersion = parseInt(navigator.appVersion,10);
  var nameOffset,verOffset,ix;
  agent.pointlock = 'pointerLockElement' in document ||
    'mozPointerLockElement' in document ||
    'webkitPointerLockElement' in document;

  // In Opera, the true version is after "Opera" or after "Version"
  if ((verOffset=nAgt.indexOf("Opera"))!=-1) {
  browserName = "Opera";
  fullVersion = nAgt.substring(verOffset+6);
  if ((verOffset=nAgt.indexOf("Version"))!=-1) 
    fullVersion = nAgt.substring(verOffset+8);
  }
  // In MSIE, the true version is after "MSIE" in userAgent
  else if ((verOffset=nAgt.indexOf("MSIE"))!=-1) {
  browserName = "Microsoft Internet Explorer";
  fullVersion = nAgt.substring(verOffset+5);
  }
  // In Chrome, the true version is after "Chrome" 
  else if ((verOffset=nAgt.indexOf("Chrome"))!=-1) {
  browserName = "Chrome";
  fullVersion = nAgt.substring(verOffset+7);
  }
  // In Safari, the true version is after "Safari" or after "Version" 
  else if ((verOffset=nAgt.indexOf("Safari"))!=-1) {
  browserName = "Safari";
  fullVersion = nAgt.substring(verOffset+7);
  if ((verOffset=nAgt.indexOf("Version"))!=-1) 
    fullVersion = nAgt.substring(verOffset+8);
  }
  // In Firefox, the true version is after "Firefox" 
  else if ((verOffset=nAgt.indexOf("Firefox"))!=-1) {
  browserName = "Firefox";
  fullVersion = nAgt.substring(verOffset+8);
  }
  // In most other browsers, "name/version" is at the end of userAgent 
  else if ( (nameOffset=nAgt.lastIndexOf(' ')+1) < 
            (verOffset=nAgt.lastIndexOf('/')) ) 
  {
  browserName = nAgt.substring(nameOffset,verOffset);
  fullVersion = nAgt.substring(verOffset+1);
  if (browserName.toLowerCase()==browserName.toUpperCase()) {
    browserName = navigator.appName;
  }
  }
  // trim the fullVersion string at semicolon/space if present
  if ((ix=fullVersion.indexOf(";"))!=-1)
    fullVersion=fullVersion.substring(0,ix);
  if ((ix=fullVersion.indexOf(" "))!=-1)
    fullVersion=fullVersion.substring(0,ix);

  majorVersion = parseInt(''+fullVersion,10);
  if (isNaN(majorVersion)) {
  fullVersion  = ''+parseFloat(navigator.appVersion); 
  majorVersion = parseInt(navigator.appVersion,10);
  }
  agent.browser.name = browserName;
  agent.browser.version = fullVersion;
  agent.browser.v = majorVersion;
  agent.browser.app = navigator.appName;
  agent.browser.userAgent = navigator.userAgent;
  var OSName="Unknown OS";
  if (navigator.appVersion.indexOf("Win")!=-1) OSName="Windows";
  if (navigator.appVersion.indexOf("Mac")!=-1) OSName="MacOS";
  if (navigator.appVersion.indexOf("X11")!=-1) OSName="UNIX";
  if (navigator.appVersion.indexOf("Linux")!=-1) OSName="Linux";

  agent.browser.os = OSName;
  agent.mobile = (typeof window.orientation !== "undefined") || (navigator.userAgent.indexOf('IEMobile') !== -1);

  document.getElementById("userAgent").value = JSON.stringify(agent);
</script>

<style type="text/css">
  fieldset {
    padding: 10px;
    background: #fbfbfb;
    border-radius: 5px;
    margin-bottom: 5px;
  }

  #instructions {
    padding: 10px;
  }

  .previews {
    width: 33%;
    height: 180px;
  }

  .center {
  display: block;
  margin-left: auto;
  margin-right: auto;
}

  .input_location {
    background-color: blanchedalmond;
    padding: 10px;
  }
</style>
